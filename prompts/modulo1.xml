<task>
  <module>Módulo 1: Gestão de Acesso (Usuários e Login)</module>
  <objective>
    Implementar autenticação e autorização completa do sistema usando sessions.
    - Backend: CRUD de usuários, autenticação baseada em sessions, middleware de autorização (Proxy Pattern)
    - Frontend: Telas de Login, Cadastro e Listagem de Usuários integradas com navegação
  </objective>

  <files>
    <!-- BACKEND - AUTENTICAÇÃO E AUTORIZAÇÃO -->
    <!-- CONFIGURAÇÃO SESSIONS -->
    <file type="backend">
      <path>config/session.js</path>
      <purpose>Configuração do middleware de sessions</purpose>
      <requirements>
        - Usar express-session
        - Session store em memória (para desenvolvimento)
        - Cookie seguro com httpOnly
        - Configurar tempo de expiração (24h)
        - Secret a partir de variável de ambiente
      </requirements>
    </file>

    <!-- MIDDLEWARE DE AUTENTICAÇÃO -->
    <file type="backend">
      <path>middleware/authMiddleware.js</path>
      <purpose>Middleware de autenticação baseado em sessions e autorização (Proxy Pattern)</purpose>
      <requirements>
        - requireAuth: verifica se usuário está na session (se req.session.user existe)
        - requireRole: verifica se o usuário na session tem a função necessária (ex: ['Gerente'])
        - Se não autenticado → redirecionar para login (ou 401 para API)
        - Se não autorizado → retornar 403
        - O middleware de autorização atua como Protection Proxy, bloqueando requisições antes de chegar ao service
      </requirements>
    </file>

    <!-- CONTROLLERS -->
    <file type="backend">
      <path>controllers/authController.js</path>
      <purpose>Controlador para autenticação (login, logout, verificação)</purpose>
      <requirements>
        - POST /api/auth/login: autentica usuário e cria session (salva user.id e user.funcao na session)
        - POST /api/auth/logout: destrói a session
        - GET /api/auth/me: retorna dados do usuário logado (da session)
        - Usar bcrypt para comparar senhas
      </requirements>
    </file>

    <file type="backend">
      <path>controllers/userController.js</path>
      <purpose>Controlador para CRUD de usuários</purpose>
      <requirements>
        - GET /api/usuarios: lista usuários (apenas Gerente) - aplicar requireAuth e requireRole(['Gerente'])
        - POST /api/usuarios: cria usuário (apenas Gerente) - aplicar requireAuth e requireRole(['Gerente'])
        - PUT /api/usuarios/:id: atualiza usuário (apenas Gerente) - aplicar requireAuth e requireRole(['Gerente'])
        - DELETE /api/usuarios/:id: desativa usuário (apenas Gerente) - aplicar requireAuth e requireRole(['Gerente'])
        - Validar dados de entrada
      </requirements>
    </file>

    <!-- SERVICES E DATA -->
    <file type="backend">
      <path>services/userService.js</path>
      <purpose>Lógica de negócio para usuários</purpose>
      <requirements>
        - createUser: cria usuário com senha criptografada
        - getUserByEmail: busca usuário por email
        - getAllUsers: lista todos os usuários
        - updateUser: atualiza dados do usuário
        - deleteUser: desativa usuário (soft delete)
        - Validar regras de negócio
      </requirements>
    </file>

    <file type="backend">
      <path>data/userData.js</path>
      <purpose>Camada de acesso a dados para usuários</purpose>
      <requirements>
        - Métodos SQL para operações CRUD
        - Incluir queries para buscar por email, id, etc.
        - Usar conexão singleton do database.js
        - Tratar erros de SQL
      </requirements>
    </file>

    <!-- ROTAS -->
    <file type="backend">
      <path>routes/authRoutes.js</path>
      <purpose>Rotas de autenticação</purpose>
      <requirements>
        - POST /login
        - POST /logout  
        - GET /me
        - Todas as rotas públicas
      </requirements>
    </file>

    <file type="backend">
      <path>routes/userRoutes.js</path>
      <purpose>Rotas de usuários protegidas</purpose>
      <requirements>
        - GET / - lista usuários (apenas Gerente)
        - POST / - cria usuário (apenas Gerente)
        - PUT /:id - atualiza usuário (apenas Gerente)
        - DELETE /:id - desativa usuário (apenas Gerente)
        - Aplicar middleware de autenticação e autorização (requireAuth e requireRole)
      </requirements>
    </file>

    <!-- FRONTEND - TELAS DE USUÁRIO E LOGIN -->
    <file type="frontend">
      <path>public/js/auth.js</path>
      <purpose>Gerenciamento de autenticação no frontend (com sessions)</purpose>
      <requirements>
        - login(email, senha): autentica usuário e redireciona para a página principal
        - logout(): faz logout e redireciona para login
        - checkAuth(): verifica se há usuário logado (pode fazer uma requisição para /api/auth/me)
        - isManager(): verifica se o usuário atual é gerente (usando dados da session)
        - Interceptar requests para verificar autenticação
      </requirements>
    </file>

    <file type="frontend">
      <path>public/login.html</path>
      <purpose>Tela de login do sistema</purpose>
      <requirements>
        - Formulário com email e senha
        - Validação de campos
        - Integração com auth.js
        - Redirecionamento após login bem-sucedido
        - Link para recuperação de senha (placeholder)
      </requirements>
    </file>

    <file type="frontend">
      <path>public/css/login.css</path>
      <purpose>Estilos específicos para tela de login</purpose>
      <requirements>
        - Layout centralizado
        - Card de login estilizado
        - Formulário responsivo
        - Feedback visual para erros/sucesso
      </requirements>
    </file>

    <file type="frontend">
      <path>public/users.html</path>
      <purpose>Tela de gerenciamento de usuários</purpose>
      <requirements>
        - Lista de usuários em tabela
        - Modal para adicionar/editar usuários
        - Botões de ação (editar, desativar)
        - Filtro por status/função
        - Integração com breadcrumbs
      </requirements>
    </file>

    <file type="frontend">
      <path>public/js/users.js</path>
      <purpose>Lógica para gerenciamento de usuários</purpose>
      <requirements>
        - Carregar lista de usuários da API
        - Abrir modal para criar/editar usuários
        - Validar formulário de usuário
        - Enviar dados para API
        - Tratar erros de permissão
      </requirements>
    </file>

    <file type="frontend">
      <path>public/css/users.css</path>
      <purpose>Estilos específicos para tela de usuários</purpose>
      <requirements>
        - Estilos para tabela de usuários
        - Modal de formulário
        - Indicadores visuais de status
        - Layout responsivo
      </requirements>
    </file>

    <!-- ATUALIZAÇÕES DO MÓDULO 0 -->
    <file type="frontend">
      <path>public/js/app.js</path>
      <purpose>Atualizar para integrar autenticação</purpose>
      <requirements>
        - Verificar autenticação ao carregar app (usando checkAuth)
        - Redirecionar para login se não autenticado
        - Mostrar/ocultar menus baseado na função do usuário (usando isManager)
        - Integrar logout na interface
      </requirements>
    </file>

    <file type="frontend">
      <path>public/index.html</path>
      <purpose>Atualizar menu para incluir gestão de usuários</purpose>
      <requirements>
        - Adicionar item "Usuários" no menu (apenas para Gerentes) - ocultar se não for gerente
        - Adicionar item "Logout" no menu
        - Mostrar nome do usuário logado
      </requirements>
    </file>

    <!-- ATUALIZAÇÃO SERVER.JS -->
    <file type="backend">
      <path>server.js</path>
      <purpose>Atualizar para incluir session middleware</purpose>
      <requirements>
        - Importar e usar session middleware
        - Garantir que session middleware seja usado antes das rotas
      </requirements>
    </file>
  </files>

  <patterns>
    <pattern name="Proxy (Protection Proxy)">
      Implementado no middleware de autorização (requireRole) que intercepta requisições e verifica permissões (baseadas na session) antes de acessar os serviços. Mantém a segurança separada da lógica de negócio.
    </pattern>

    <pattern name="Session-based Authentication">
      Autenticação stateful usando sessions do Express. O servidor armazena a session e o cliente envia um cookie com o session ID.
    </pattern>
  </patterns>

  <dependencies>
    - Módulo 0 completamente implementado
    - Banco de dados com tabela 'usuarios'
    - Dependências: express-session, bcrypt
  </dependencies>

  <package_json_update>
    Adicionar dependência:
    "express-session": "^1.17.3"
  </package_json_update>

  <testing_scenarios>
    1. Login com credenciais corretas → deve criar session e redirecionar
    2. Login com credenciais erradas → deve retornar erro
    3. Acessar /api/usuarios sem session → deve retornar 401 ou redirecionar
    4. Acessar /api/usuarios como Colaborador → deve retornar 403
    5. Acessar /api/usuarios como Gerente → deve retornar 200
    6. Criar usuário como Gerente → deve funcionar
    7. Criar usuário como Colaborador → deve retornar 403
    8. Logout → deve destruir session e redirecionar para login
  </testing_scenarios>
</task>