<task>
  <submodule>3.3: Testes Automatizados do Backend</submodule>
  <objective>
    Configurar ambiente de testes automatizados e implementar testes para o serviço de estoque e API de movimentações.
    - Configurar Jest + Supertest para testes de backend
    - Criar testes unitários para estoqueService
    - Criar testes de integração para API de movimentações
    - Garantir cobertura dos cenários críticos de negócio
  </objective>

  <files>
    <!-- CONFIGURAÇÃO DO JEST -->
    <file type="backend">
      <path>package.json</path>
      <purpose>Adicionar dependências e scripts de teste</purpose>
      <requirements>
        - Adicionar dependências de desenvolvimento:
          * "jest": "^29.0.0"
          * "supertest": "^6.0.0"
        - Adicionar scripts:
          * "test": "jest"
          * "test:watch": "jest --watch"
          * "test:coverage": "jest --coverage"
        - Configurar Jest para ambiente Node.js
      </requirements>
    </file>

    <file type="backend">
      <path>jest.config.js</path>
      <purpose>Configuração do Jest para o projeto</purpose>
      <requirements>
        - Configurar testEnvironment como "node"
        - Definir collectCoverageFrom para incluir arquivos relevantes
        - Configurar testMatch para encontrar arquivos .test.js
        - Incluir setupFilesAfterEnv se necessário
        - Configurar coverage thresholds básicos
      </requirements>
    </file>

    <!-- SETUP DE TESTES -->
    <file type="backend">
      <path>tests/setup.js</path>
      <purpose>Configuração global para os testes</purpose>
      <requirements>
        - Configurar ambiente de teste
        - Conectar ao banco de testes (ou usar SQLite em memória)
        - Criar funções para limpar dados entre testes
        - Configurar mocks globais se necessário
        - Criar dados de teste (usuários, produtos, locais)
      </requirements>
    </file>

    <!-- TESTES UNITÁRIOS DO ESTOQUESERVICE -->
    <file type="backend">
      <path>tests/estoqueService.test.js</path>
      <purpose>Testes unitários para o serviço central de estoque</purpose>
      <requirements>
        - Testar registrarEntrada com dados válidos
        - Testar registrarSaida com estoque suficiente
        - Testar registrarSaida com estoque insuficiente (deve falhar)
        - Testar transferência com dados válidos
        - Testar transferência com locais iguais (deve falhar)
        - Testar transferência com estoque insuficiente (deve falhar)
        - Testar transações (rollback em caso de erro)
        - Testar cálculos de estoque atual
        - Usar mocks para dependências externas quando necessário
      </requirements>
    </file>

    <!-- TESTES DE INTEGRAÇÃO DA API -->
    <file type="backend">
      <path>tests/movimentacaoAPI.test.js</path>
      <purpose>Testes de integração para endpoints da API</purpose>
      <requirements>
        - Testar POST /api/movimentacoes/entrada (sucesso)
        - Testar POST /api/movimentacoes/entrada (validação falha)
        - Testar POST /api/movimentacoes/saida (sucesso)
        - Testar POST /api/movimentacoes/saida (estoque insuficiente)
        - Testar POST /api/movimentacoes/transferencia (sucesso)
        - Testar POST /api/movimentacoes/transferencia (locais iguais)
        - Testar autenticação (acesso sem login)
        - Testar GET /api/movimentacoes/historico
        - Usar Supertest para fazer requisições HTTP
      </requirements>
    </file>

    <!-- MOCKS E UTILITÁRIOS -->
    <file type="backend">
      <path>tests/mocks/database.js</path>
      <purpose>Mocks para o módulo de database</purpose>
      <requirements>
        - Mock para database.beginTransaction()
        - Mock para database.commit()
        - Mock para database.rollback()
        - Mock para conexão de banco de dados
        - Configurar comportamentos para diferentes cenários de teste
      </requirements>
    </file>

    <file type="backend">
      <path>tests/helpers/testData.js</path>
      <purpose>Dados de teste reutilizáveis</purpose>
      <requirements>
        - Criar usuários de teste (gerente, colaborador)
        - Criar produtos de teste
        - Criar locais de teste
        - Funções para criar/limpar dados de teste
      </requirements>
    </file>
  </files>

  <test_scenarios>
    <scenario>
      <name>Entrada de Estoque Bem-sucedida</name>
      <description>Registrar entrada deve incrementar estoque</description>
      <steps>
        1. Dado um produto e local existentes
        2. Quando registrar entrada de 10 unidades
        3. Então o estoque deve aumentar em 10
        4. E uma movimentação do tipo "Entrada" deve ser criada
      </steps>
    </scenario>

    <scenario>
      <name>Saída com Estoque Insuficiente</name>
      <description>Tentar saída sem estoque deve falhar</description>
      <steps>
        1. Dado um produto com estoque 5
        2. Quando tentar registrar saída de 10 unidades
        3. Então deve lançar ErroEstoqueInsuficiente
        4. E nenhuma movimentação deve ser criada
        5. E o estoque deve permanecer 5
      </steps>
    </scenario>

    <scenario>
      <name>Transferência Bem-sucedida</name>
      <description>Transferir entre locais deve atualizar ambos</description>
      <steps>
        1. Dado produto com estoque 10 no Local A
        2. Quando transferir 5 unidades para Local B
        3. Então Local A deve ter estoque 5
        4. E Local B deve ter estoque 5
        5. E uma movimentação de transferência deve ser criada
      </steps>
    </scenario>
  </test_scenarios>

  <coverage_goals>
    - estoqueService: 90%+ (crítico)
    - movimentacaoController: 80%+
    - API endpoints: 85%+
    - Cenários de erro: 100%
    - Transações: 100%
  </coverage_goals>

  <database_testing_strategy>
    <approach>Banco de Teste SQLite em Memória</approach>
    <reason>Rápido e isolado para testes</reason>
    <setup>
      - Usar SQLite :memory: para testes
      - Executar migrations antes de cada suite de testes
      - Popular com dados básicos antes de cada teste
      - Limpar dados entre testes individuais
    </setup>
  </database_testing_strategy>

  <authentication_testing>
    - Testar endpoints com usuário autenticado
    - Testar endpoints sem autenticação (deve retornar 401)
    - Usar tokens de sessão de teste
    - Testar com diferentes tipos de usuário (gerente, colaborador)
  </authentication_testing>

  <error_scenarios>
    - Produto não encontrado
    - Local não encontrado
    - Quantidade zero ou negativa
    - Locais iguais na transferência
    - Estoque insuficiente
    - Erro de banco de dados
    - Usuário não autenticado
  </error_scenarios>

  <dependencies>
    - Sub-módulo 3.1 implementado (estoqueService)
    - Sub-módulo 3.2 implementado (API de movimentações)
    - Model de Movimentacao implementado
  </dependencies>

  <implementation_notes>
    - Focar em testes que garantam o comportamento crítico do negócio
    - Testar transações com cenários de rollback
    - Mockar apenas o necessário (testes de integração com banco real)
    - Manter testes independentes (limpar dados entre testes)
    - Usar describe/it do Jest para organização clara
  </implementation_notes>

  <ci_cd_preparation>
    - Configurar para rodar testes automaticamente
    - Gerar relatório de cobertura
    - Fail rápido em caso de testes quebrados
    - Script para rodar testes antes do commit (opcional)
  </ci_cd_preparation>
</task>