<task>
  <submodule>4.2: Sistema de Alertas Backend</submodule>
  <objective>
    Implementar o sistema de detecção e gestão de alertas para estoque mínimo e validade próxima.
    - Criar lógica para detectar produtos com estoque abaixo do mínimo
    - Criar lógica para detectar produtos com validade próxima
    - Implementar endpoints para listar e gerenciar alertas
    - Criar estrutura de dados para armazenar alertas
  </objective>

  <files>
    <!-- SERVIÇO DE DETECÇÃO DE ALERTAS -->
    <file type="backend">
      <path>services/alertaService.js</path>
      <purpose>Serviço para detecção e gestão de alertas</purpose>
      <requirements>
        - detectarAlertasEstoque: identificar produtos com estoque abaixo do mínimo
        - detectarAlertasValidade: identificar produtos com validade próxima (7 dias)
        - criarAlerta: registrar novo alerta no sistema
        - listarAlertasAtivos: buscar alertas não lidos
        - marcarComoLido: atualizar status do alerta para lido
        - getAlertasRecentes: buscar alertas recentes para o dashboard
        - Usar data layers existentes para consultar produtos e estoque
        - Evitar duplicação de alertas para o mesmo produto/motivo
      </requirements>
    </file>

    <!-- ROTAS DE ALERTAS -->
    <file type="backend">
      <path>routes/alertaRoutes.js</path>
      <purpose>Definir rotas para gestão de alertas</purpose>
      <requirements>
        - GET /api/alertas - Listar alertas (com filtros opcionais: tipo, lido)
        - POST /api/alertas/marcar-lido - Marcar alerta como lido
        - GET /api/alertas/contagem - Retornar contagem de alertas não lidos (para badge)
        - Aplicar middleware requireAuth em todas as rotas
        - Todos os usuários autenticados podem ver alertas
        - Usar controladores do alertaController
      </requirements>
    </file>

    <!-- CONTROLADOR DE ALERTAS -->
    <file type="backend">
      <path>controllers/alertaController.js</path>
      <purpose>Controlador para operações de alertas</purpose>
      <requirements>
        - listarAlertas: retornar lista de alertas com filtros
        - marcarComoLido: atualizar status de um alerta para lido
        - getContagemAlertas: retornar contagem de alertas não lidos
        - executarDetecaoAlertas: endpoint para forçar detecção de alertas (opcional, para testes)
        - Validar parâmetros de entrada
        - Retornar respostas no formato padrão da API
        - Tratar erros com try/catch
      </requirements>
    </file>

    <!-- CAMADA DE DADOS DE ALERTAS -->
    <file type="backend">
      <path>data/alertaData.js</path>
      <purpose>Camada de acesso a dados para alertas</purpose>
      <requirements>
        - create: inserir novo alerta
        - findByProdutoLocalTipo: buscar alerta específico para evitar duplicatas
        - findAll: listar alertas com filtros (tipo, lido, data)
        - update: atualizar alerta (marcar como lido)
        - countNaoLidos: contar alertas não lidos
        - deleteOld: remover alertas antigos (opcional, para manutenção)
        - Usar conexão singleton do database.js
      </requirements>
    </file>

    <!-- ATUALIZAÇÃO DO SERVIDOR -->
    <file type="backend">
      <path>server.js</path>
      <purpose>Registrar rotas de alertas no servidor</purpose>
      <requirements>
        - Importar e usar alertaRoutes
        - Adicionar após outras rotas de API
        - Manter ordem consistente
      </requirements>
    </file>
  </files>

  <alert_types>
    <type>
      <name>estoque_minimo</name>
      <description>Produto com estoque abaixo do mínimo configurado</description>
      <detection_logic>
        - Para cada produto ativo em cada local
        - Calcular estoque atual (entradas - saídas + transferências)
        - Comparar com campo estoque_minimo do produto
        - Se estoque_atual <= estoque_minimo → gerar alerta
      </detection_logic>
    </type>

    <type>
      <name>validade_proxima</name>
      <description>Produto com data de validade próxima (7 dias)</description>
      <detection_logic>
        - Para cada produto com data_validade preenchida
        - Calcular dias até a validade
        - Se dias <= 7 → gerar alerta
      </detection_logic>
    </type>
  </alert_types>

  <api_endpoints>
    <endpoint>
      <method>GET</method>
      <path>/api/alertas</path>
      <query_params>?tipo=estoque_minimo&lido=false</query_params>
      <response>
        {
          "success": true,
          "alertas": [
            {
              "id": 1,
              "tipo": "estoque_minimo",
              "produto_id": 5,
              "produto_nome": "Farinha de Trigo",
              "local_id": 1,
              "local_nome": "Loja Principal",
              "estoque_atual": 2,
              "estoque_minimo": 10,
              "data_validade": null,
              "dias_ate_validade": null,
              "data_criacao": "2024-01-15T10:30:00Z",
              "lido": false
            }
          ]
        }
      </response>
    </endpoint>

    <endpoint>
      <method>POST</method>
      <path>/api/alertas/marcar-lido</path>
      <body>
        {
          "alerta_id": 1
        }
      </body>
      <response>
        {
          "success": true,
          "message": "Alerta marcado como lido"
        }
      </response>
    </endpoint>

    <endpoint>
      <method>GET</method>
      <path>/api/alertas/contagem</path>
      <response>
        {
          "success": true,
          "contagem": 7
        }
      </response>
    </endpoint>
  </api_endpoints>

  <database_considerations>
    - A tabela 'alertas' já foi criada no Módulo 0
    - Estrutura existente: id, tipo, produto_id, mensagem, lida, data_alerta
    - Pode ser necessário adicionar campos: local_id, estoque_atual, estoque_minimo, data_validade
    - Ou manter estrutura simples e calcular dados na consulta
  </database_considerations>

  <integration_notes>
    - Reutilizar serviços existentes: produtoService, movimentacaoData para cálculos
    - Usar mesmo padrão de responses da API
    - Alertas serão consumidos pelo Sub-módulo 4.8 (Frontend de Alertas)
    - Contagem de alertas será usada pelo Sub-módulo 4.6 (Dashboard) para badge
  </integration_notes>

  <dependencies>
    - Sub-módulo 4.1 implementado (base do dashboard)
    - Módulo 2 implementado (produtos com estoque_minimo e data_validade)
    - Módulo 3 implementado (cálculo de estoque atual)
    - Tabela 'alertas' criada no Módulo 0
  </dependencies>

  <testing_focus>
    - Detecção de estoque mínimo: produto com estoque abaixo do mínimo gera alerta
    - Detecção de validade: produto com validade próxima gera alerta
    - Não duplicação: mesmo produto/motivo não gera alerta duplicado
    - Marcar como lido: alerta muda status e some das listas não lidas
    - Contagem: retorna número correto de alertas não lidos
  </testing_focus>

  <next_steps_preparation>
    - Estes serviços serão usados pelo Sub-módulo 4.8 (Frontend de Alertas)
    - A contagem de alertas será usada no badge do menu
    - A detecção pode ser chamada periodicamente (cron job futuro)
  </next_steps_preparation>

    <!-- alterações -->
    <?xml version="1.0" encoding="UTF-8"?>
    <alteracoes>
        <modulo>4.2</modulo>
        <descricao>Alterações complementares para implementação do sistema de alertas</descricao>
        <detalhes>
            <alteracao>
            <tipo>Integração</tipo>
            <descricao>Integração com estoqueService para cálculo de estoque atual em vez de apenas movimentacaoData</descricao>
            <justificativa>Utilizar o estoqueService.getEstoqueAtual() para cálculos mais precisos e consistentes com a lógica central de estoque</justificativa>
            </alteracao>
            <alteracao>
            <tipo>Estrutura de dados</tipo>
            <descricao>Adaptar estrutura da tabela de alertas para incluir local_id quando necessário</descricao>
            <justificativa>Os alertas de estoque mínimo precisam referenciar o local específico onde o estoque está baixo</justificativa>
            </alteracao>
            <alteracao>
            <tipo>Validação</tipo>
            <descricao>Implementar lógica de validação para evitar alertas duplicados baseados no tipo e produto</descricao>
            <justificativa>Prevenir geração excessiva de alertas para o mesmo problema</justificativa>
            </alteracao>
        </detalhes>
    </alteracoes>
</task>