<task>
  <submodule>2.2: Backend de Produtos</submodule>
  <objective>
    Implementar a API completa para gerenciamento de produtos.
    - CRUD completo para produtos (Create, Read, Update, Delete/Inativar)
    - Aplicar middleware de autorização: apenas Gerentes podem criar/editar/excluir
    - Validações: nome obrigatório, preço positivo, estoque mínimo positivo
    - Campos com opções fixas: unidade_medida, categoria, tipo, status
    - Soft delete usando campo status
  </objective>

  <files>
    <!-- ROTAS PARA PRODUTOS -->
    <file type="backend">
      <path>routes/produtoRoutes.js</path>
      <purpose>Rotas para CRUD de produtos com proteção de autorização</purpose>
      <requirements>
        - GET /api/produtos - Lista todos os produtos (acesso: todos usuários autenticados)
        - GET /api/produtos/:id - Busca produto por ID (acesso: todos usuários autenticados)
        - POST /api/produtos - Cria novo produto (acesso: apenas Gerentes)
        - PUT /api/produtos/:id - Atualiza produto (acesso: apenas Gerentes)
        - DELETE /api/produtos/:id - Inativa produto (soft delete) (acesso: apenas Gerentes)
        - Aplicar middleware requireAuth em todas as rotas
        - Aplicar middleware requireRole(['Gerente']) nas rotas POST, PUT, DELETE
      </requirements>
    </file>

    <!-- CONTROLADOR DE PRODUTOS -->
    <file type="backend">
      <path>controllers/produtoController.js</path>
      <purpose>Controlador para operações de produtos</purpose>
      <requirements>
        - listarProdutos: retorna todos os produtos (com filtros opcionais)
        - buscarProdutoPorId: retorna produto específico
        - criarProduto: valida dados e cria novo produto
        - atualizarProduto: valida dados e atualiza produto existente
        - inativarProduto: muda status para "Indisponível" (soft delete)
        - Validar dados de entrada:
          * nome: obrigatório, string
          * preco: número positivo (opcional)
          * estoque_minimo: número não negativo (opcional, default 0)
          * unidade_medida: deve ser uma das opções: ['unidade', 'kg', 'litro']
          * categoria: deve ser uma das opções: ['doce', 'salgado', 'bebida', 'outro']
          * tipo: deve ser uma das opções: ['Matéria-prima', 'Produto semiacabado', 'Produto acabado']
          * data_validade: date (opcional)
        - Retornar códigos HTTP apropriados (200, 201, 400, 404, 500)
      </requirements>
    </file>

    <!-- SERVIÇO DE PRODUTOS -->
    <file type="backend">
      <path>services/produtoService.js</path>
      <purpose>Lógica de negócio para produtos</purpose>
      <requirements>
        - listarTodos: retorna todos os produtos (com filtros)
        - buscarPorId: busca produto por ID
        - criar: valida regras de negócio e cria produto
        - atualizar: valida e atualiza produto
        - inativar: muda status para "Indisponível"
        - Validar se produto existe antes de operações
        - Validar enumerações (unidade_medida, categoria, tipo, status)
        - Garantir que não há movimentações ativas antes de inativar (verificação futura)
      </requirements>
    </file>

    <!-- CAMADA DE DADOS DE PRODUTOS -->
    <file type="backend">
      <path>data/produtoData.js</path>
      <purpose>Camada de acesso a dados para produtos</purpose>
      <requirements>
        - findAll: busca todos os produtos (com filtro de status por padrão)
        - findById: busca produto por ID
        - create: insere novo produto no banco
        - update: atualiza produto existente
        - inactivate: muda status para "Indisponível"
        - Validar valores de enumerações no SQL quando possível
        - Usar conexão singleton do database.js
        - Usar prepared statements para evitar SQL injection
        - Retornar promises para operações assíncronas
      </requirements>
    </file>

    <!-- ATUALIZAÇÃO DO SERVIDOR -->
    <file type="backend">
      <path>server.js</path>
      <purpose>Adicionar rotas de produtos ao servidor</purpose>
      <requirements>
        - Importar e usar produtoRoutes
        - Garantir que as rotas sejam adicionadas após o middleware de sessions
      </requirements>
    </file>
  </files>

  <database_schema>
    A tabela 'produtos' já existe com a estrutura:
    - id INT AUTO_INCREMENT PRIMARY KEY
    - nome VARCHAR(100) NOT NULL
    - descricao TEXT
    - preco DECIMAL(10,2)
    - unidade_medida VARCHAR(20) DEFAULT 'unidade'
    - categoria VARCHAR(50)
    - estoque_minimo DECIMAL(10,2) DEFAULT 0
    - fabricante VARCHAR(100)
    - tipo ENUM('Matéria-prima', 'Produto semiacabado', 'Produto acabado') DEFAULT 'Matéria-prima'
    - data_validade DATE NULL
    - status ENUM('Disponível', 'Indisponível') DEFAULT 'Disponível'
    - data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  </database_schema>

  <enums_definitions>
    - unidade_medida: ['unidade', 'kg', 'litro']
    - categoria: ['doce', 'salgado', 'bebida', 'outro']
    - tipo: ['Matéria-prima', 'Produto semiacabado', 'Produto acabado']
    - status: ['Disponível', 'Indisponível']
  </enums_definitions>

  <permissions_structure>
    - Rotas GET: requireAuth (todos usuários autenticados)
    - Rotas POST, PUT, DELETE: requireAuth + requireRole(['Gerente'])
  </permissions_structure>

  <validation_rules>
    - nome: obrigatório, string, mínimo 2 caracteres
    - preco: opcional, se informado deve ser número positivo
    - estoque_minimo: opcional, se informado deve ser número não negativo
    - unidade_medida: deve ser uma das opções pré-definidas
    - categoria: deve ser uma das opções pré-definidas
    - tipo: deve ser uma das opções pré-definidas
    - data_validade: opcional, deve ser data futura ou null
  </validation_rules>

  <error_handling>
    - 400: Dados de entrada inválidos (validação falhou)
    - 401: Não autenticado
    - 403: Não autorizado (usuário não é Gerente)
    - 404: Produto não encontrado
    - 500: Erro interno do servidor
  </error_handling>

  <testing_scenarios>
    1. Listar produtos como usuário autenticado → deve retornar 200 com array
    2. Criar produto como Gerente → deve retornar 201 com produto criado
    3. Criar produto como Colaborador → deve retornar 403
    4. Atualizar produto como Gerente → deve retornar 200
    5. Atualizar produto como Colaborador → deve retornar 403
    6. Inativar produto como Gerente → deve retornar 200
    7. Inativar produto como Colaborador → deve retornar 403
    8. Buscar produto inexistente → deve retornar 404
    9. Criar produto com categoria inválida → deve retornar 400
    10. Criar produto com preço negativo → deve retornar 400
  </testing_scenarios>

  <dependencies>
    - Módulo 1 completamente implementado (autenticação, middleware de autorização)
    - Sub-módulo 2.1 implementado (para referência de padrões)
    - Banco de dados com tabela 'produtos' criada
  </dependencies>

  <integration_notes>
    - As rotas devem ser prefixadas com /api/produtos
    - O middleware de autorização deve ser reutilizado do Módulo 1
    - Manter consistência com padrões de resposta da API existentes
    - Usar mesma estrutura de controllers/services/data do Sub-módulo 2.1
  </integration_notes>
</task>